Wind.UI.Datalist = function () { var a = arguments[0] || {}; this.header = a.header; this.renderTo = a.renderTo; this.width = a.width || "100%"; this.height = a.height || "100%"; this.onclickEvent = a.click; this.ondblclickEvent = a.dblclick; this.onclickHeaderEvent = a.clickHeader; this.isClickSelect = a.isClickSelect == undefined || a.isClickSelect; this.isMouseoverSelect = a.isMouseoverSelect == undefined || a.isMouseoverSelect; this.pageSetting = a.pageSetting; this.imagePath = a.imagePath; this.emptyText = a.emptyText || "无数据!"; this.isLockHeader = a.isLockHeader || false; this.isEnableAlternating = a.isEnableAlternating == undefined || a.isEnableAlternating; this.isShowHeader = a.isShowHeader == undefined || a.isShowHeader; this.tbodyID = this.renderTo + "_tbody"; this.headersPanelID = this.renderTo + "_headers"; this.emptyTRID = this.renderTo + "_emptyTR"; this.tableContainerID = this.renderTo + "_tableContainer" }; Wind.UI.Datalist.prototype = { DataBind: function (b, a) { if (this.header) { this.columnCount = this.header.length } if (this.isFirstLoad == undefined) { this.isFirstLoad = true } else { this.isFirstLoad = false } this.dataSource = this.__convertObjToArray(b); this.__formatDataSource(); this.paging = a; this.__render(a); this.__bindEvent() }, GetSelectValue: function (a) { if (this.isClickSelect) { if (a) { return this.dataSource[this.currentRowIndex][a] } else { return this.currentRowIndex } } else { return null } }, UpdateWords: function (d, c) { var b = $("#" + this.headersPanelID + " td div span"); if (b.length > 0) { for (var a = 0; a < b.length; a++) { b[a].innerHTML = d[a] } } this.pageBox.UpdateWords(c) }, __convertObjToArray: function (c) { var a = []; if (c && c.length > 0) { for (var b = 0; b < c.length; b++) { a.push(c[b]) } } return a }, __render: function (d) { if (this.isFirstLoad) { if (this.renderTo) { document.getElementById(this.renderTo).style.cssText += ("position: relative;overflow: hidden;height:{0};").format(this.__formatWHCssText(this.height)) } var g = "grid3_hd grid3_cell"; var b = new StringBuilder(); b.append(("<div id='{0}' style='width:{1};overflow:auto'>").format(this.tableContainerID, this.__formatWHCssText(this.width))); b.append(("<table cellspacing='0' cellpadding='0' border='0' style='width: {0};table-layout: fixed; word-break: break-all;border:solid 1px #D0D0D0;'>").format(this.__formatWHCssText(this.width))); if (this.isShowHeader) { b.append("<thead>"); b.append(("<tr id='{0}' class='grid3_hd_row'>").format(this.headersPanelID)); var c = ""; for (var a = 0; a < this.columnCount; a++) { if (this.isLockHeader) { if (this.header[a]["isLocked"]) { g = "grid3_hd grid3_cell fixLeftTop" } else { g = "grid3_hd grid3_cell fixTop" } } if (this.header[a]["width"]) { b.append(("<td style='width: {0};' class='{1}'>").format(this.__formatWHCssText(this.header[a]["width"]), g)) } else { b.append(("<td class='{0}'>").format(g)) } if (this.header[a]["align"]) { c += ("text-align: {0};").format(this.header[a]["align"]) } if (this.header[a]["sortable"]) { c += "cursor:pointer;" } if (c) { b.append(("<div  class='grid3_hd_inner' style='{0}'>").format(c)) } else { b.append("<div  class='grid3_hd_inner'>") } c = ""; b.append("<span>" + this.header[a]["header"] + "</span>"); b.append("<img src='data:image/gif;base64,R0lGODlhAQABAID/AMDAwAAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==' class='grid3_sort_icon'>"); b.append("</div></td>") } b.append("</tr></thead>") } b.append(("<tbody id='{0}'>").format(this.tbodyID)); b.append("</tbody>"); b.append("</table>"); b.append("</div>"); if (this.pageSetting) { b.append(("<div id='{0}' class='PageBox' style='position:static'></div>").format(this.renderTo + "_Foot")) } document.getElementById(this.renderTo).innerHTML = b.toString(); b.clear(); if (!document.getElementById(this.emptyTRID)) { document.getElementById(this.tbodyID).appendChild(this.__renderEmptyTRHTML()) } if (this.dataSource && this.dataSource.length > 0) { for (var a = 0; a < this.dataSource.length; a++) { document.getElementById(this.tbodyID).appendChild(this.__renderTRHTML(a)) } } } else { var f = $("#" + this.tbodyID + " tr.grid3_row").length - 1; var e; if (this.dataSource.length < f) { for (var a = 0; a < f; a++) { e = $($("#" + this.tbodyID + " tr.grid3_row")[a + 1]); if (a >= this.dataSource.length) { e.hide() } else { e.show() } this.__rebindTRData(a) } } else { if (this.dataSource.length > f) { for (var a = 0; a < this.dataSource.length; a++) { if (a < f) { $($("#" + this.tbodyID + " tr.grid3_row")[a + 1]).show(); this.__rebindTRData(a) } else { document.getElementById(this.tbodyID).appendChild(this.__renderTRHTML(a)) } } } else { for (var a = 0; a < f; a++) { $($("#" + this.tbodyID + " tr.grid3_row")[a + 1]).show(); this.__rebindTRData(a) } } } } if (!this.dataSource || this.dataSource.length == 0) { document.getElementById(this.emptyTRID).style.display = "" } else { if (document.getElementById(this.emptyTRID)) { document.getElementById(this.emptyTRID).style.display = "none" } } if (this.pageSetting) { this.__renderPageBox(d); if (typeof this.height == "number") { document.getElementById(this.tableContainerID).style.height = (document.getElementById(this.renderTo).offsetHeight - document.getElementById(this.renderTo).offsetHeight) + "px" } } }, __renderTRHTML: function (c) { var b = ""; var e = "grid3_row"; if (this.isEnableAlternating) { if (c % 2 == 1) { e = "grid3_row grid3_row_alt" } else { e = "grid3_row" } } var d = document.createElement("tr"); d.className = e; for (var a = 0; a < this.columnCount; a++) { var f = document.createElement("td"); if (this.header[a]["isLocked"]) { e = "grid3_cell fixLeft" } else { e = "grid3_cell" } f.className = e; if (this.header[a]["width"]) { f.style.cssText = ("width:{0};overflow: hidden;white-space: nowrap;text-overflow: ellipsis;").format(this.__formatWHCssText(this.header[a]["width"])) } b = this.__fullinData(c, a); if ((!this.header[a]["renderer"]) && (!this.header[a]["type"])) { if (this.header[a]["textAlign"]) { if (!this.header[a]["isWrap"]) { f.innerHTML = ("<div class='grid3_cell_inner' title='{1}' style='text-align:{0};'>{1}</div>").format(this.header[a]["textAlign"], b) } else { f.innerHTML = ("<div class='grid3_cell_inner' title='{1}' style='text-align:{0};white-space: normal;'>{1}</div>").format(this.header[a]["textAlign"], b) } } else { if (!this.header[a]["isWrap"]) { f.innerHTML = ("<div class='grid3_cell_inner' title='{0}'>{0}</div>").format(b) } else { f.innerHTML = ("<div class='grid3_cell_inner' title='{0}' style='white-space: normal;'>{0}</div>").format(b) } } } else { if (this.header[a]["textAlign"]) { if (!this.header[a]["isWrap"]) { f.innerHTML = ("<div class='grid3_cell_inner'  style='text-align:{0};'>{1}</div>").format(this.header[a]["textAlign"], b) } else { f.innerHTML = ("<div class='grid3_cell_inner'  style='text-align:{0};white-space: normal;'>{1}</div>").format(this.header[a]["textAlign"], b) } } else { if (!this.header[a]["isWrap"]) { f.innerHTML = ("<div class='grid3_cell_inner' >{0}</div>").format(b) } else { f.innerHTML = ("<div class='grid3_cell_inner' style='white-space: normal;'>{0}</div>").format(b) } } } d.appendChild(f) } d.setAttribute("isBindMouseoverSelectEvent", "0"); d.setAttribute("isBindClickSelectEvent", "0"); d.setAttribute("isBindClickEvent", "0"); d.setAttribute("isBinddbClickEvent", "0"); d.setAttribute("index", c); d.id = this.tbodyID + "_" + c; return d }, __rebindTRData: function (b) { var c = $($("#" + this.tbodyID + " tr.grid3_row")[b + 1]).find("td.grid3_cell"); if (c.length > 0) { for (var a = 0; a < c.length; a++) { var d = this.__fullinData(b, a); $($(c[a]).find("div")[0]).html(d); if ((!this.header[a]["renderer"]) && (!this.header[a]["type"])) { $($(c[a]).find("div")[0]).attr("title", d) } } } }, __renderEmptyTRHTML: function () { var a = document.createElement("tr"); a.id = this.emptyTRID; a.className = "grid3_row"; var b = document.createElement("td"); b.className = "grid3_cell"; b.setAttribute("colSpan", this.columnCount); b.innerHTML = this.emptyText; b.style.padding = "10px"; b.style.textAlign = "left"; a.appendChild(b); return a }, __bindEvent: function () { if (this.isShowHeader) { if (this.isFirstLoad) { var c = $("#" + this.headersPanelID + " td"); if (c.length > 0) { for (var b = 0; b < c.length; b++) { Utils.event.addEventHandler(c[b], "mouseover", (function (d) { return function () { c[d].className += " grid3_hd_over" } })(b)); Utils.event.addEventHandler(c[b], "mouseout", (function (d) { return function () { c[d].className = c[d].className.replace("grid3_hd_over", "") } })(b)); if (this.header[b]["sortable"]) { Utils.event.addEventHandler(c[b], "click", (function (e, d) { return function () { var f = e.__clickHeader(c, d); if (e.onclickHeaderEvent) { e.onclickHeaderEvent(e.header[d]["dataIndex"], f) } else { e.__sort(e.header[d]["dataIndex"], f) } } })(this, b)) } } } } } var a = $("#" + this.tbodyID).find("tr.grid3_row"); if (this.isMouseoverSelect) { if (a.length > 0) { for (var b = 0; b < a.length; b++) { if (a[b].getAttribute("isBindMouseoverSelectEvent") == "0") { Utils.event.addEventHandler(a[b], "mouseover", (function (d) { return function () { a[d].className += " grid3_row_over" } })(b)); Utils.event.addEventHandler(a[b], "mouseout", (function (d) { return function () { a[d].className = a[d].className.replace("grid3_row_over", "") } })(b)); a[b].setAttribute("isBindMouseoverSelectEvent", "1") } } } } if (this.isClickSelect) { if (a.length > 0) { for (var b = 0; b < a.length; b++) { if (a[b].getAttribute("isBindClickSelectEvent") == "0") { Utils.event.addEventHandler(a[b], "click", (function (e, d) { return function () { for (var f = 0; f < a.length; f++) { a[f].className = a[f].className.replace("grid3_row_selected", "") } a[d].className += " grid3_row_selected"; e.currentRowIndex = d } })(this, b)); a[b].setAttribute("isBindClickSelectEvent", "1") } } } } if (this.onclickEvent) { if (a.length > 0) { for (var b = 0; b < a.length; b++) { if (a[b].getAttribute("isBindClickEvent") == "0") { Utils.event.addEventHandler(a[b], "click", (function (e, d) { return function () { e.onclickEvent(a[d].getAttribute("index")) } })(this, b)); a[b].setAttribute("isBindClickEvent", "1") } } } } if (this.ondblclickEvent) { if (a.length > 0) { for (var b = 0; b < a.length; b++) { if (a[b].getAttribute("isBinddbClickEvent") == "0") { Utils.event.addEventHandler(a[b], "dblclick", (function (e, d) { return function () { e.ondblclickEvent(a[d].getAttribute("index")) } })(this, b)); a[b].setAttribute("isBinddbClickEvent", "1") } } } } }, __fullinData: function (c, b) { var d = ""; if (c < this.dataSource.length) { if (this.header[b]["renderer"]) { if (this.header[b]["dataIndex"]) { d = this.header[b]["renderer"](c, this.dataSource[c][this.header[b]["dataIndex"]], this.dataSource[c]) } else { d = this.header[b]["renderer"](c, this.imagePath, this.dataSource[c]) } } else { if (this.header[b]["editable"] && this.header[b]["type"] == "checkbox") { if (this.dataSource[c][this.header[b]["dataIndex"]]) { d = ("<div class='{0}' id='{1}'>&nbsp;</div>").format("grid3_check grid3_check_col_on", "grid3_check_" + c + "_" + b) } else { d = ("<div class='{0}' id='{1}'>&nbsp;</div>").format("grid3_check grid3_check_col", "grid3_check_" + c + "_" + b) } } else { if (this.header[b]["type"] == "select") { d = this.dataSource[c][this.header[b]["dataIndex"]]["text"]; var e = this.header[b]["selectdata"]; if (e.length > 0) { for (var a = 0; a < e.length; a++) { if (this.dataSource[c][this.header[b]["dataIndex"]] == e[a]["value"]) { d = e[a]["text"]; break } } } } else { if (this.header[b]["type"] == "checkboxlist") { d = ""; var e = this.header[b]["data"]; if (e.length > 0) { var f = 0; for (var a = 0; a < e.length; a++) { d += ("<input id='{0}' type='checkbox' {1}>&nbsp;").format("checkboxlist_" + c + "_" + b + "_" + a, this.dataSource[c][this.header[b]["dataIndex"]][a] ? "checked='checked'" : ""); d += this.header[b]["data"][a] + "&nbsp;&nbsp;"; f++; if (this.header[b]["column"] && parseInt(this.header[b]["column"]) == f) { d += "<br />"; f = 0 } } } d = this.__renderCheckBoxListHTML(c, b) } else { if ((this.dataSource[c][this.header[b]["dataIndex"]]) || (this.dataSource[c][this.header[b]["dataIndex"]] == 0)) { d = this.dataSource[c][this.header[b]["dataIndex"]] } else { d = "&nbsp;" } } } } } } return d }, __renderCheckBoxListHTML: function (h, e) { var d = this.dataSource[h][this.header[e]["dataIndex"]]; if (d && d.length > 0) { var a = parseInt(this.header[e]["column"]); var g = []; for (var c = 0; c < d.length; c++) { var f = {}; if (this.header[e]["data"][h]) { f.text = this.header[e]["data"][h][c] } else { f.text = this.header[e]["data"][0][c] } f.value = d[c]; g.push(f) } var b = new StringBuilder(); if (g.length > 0) { b.append("<table cellpadding='0' cellspacing='0'>"); for (var c = 0; c < Math.ceil(g.length / a) * a; c++) { if (!(c % a)) { b.append("<tr>") } b.append("<td style='border:0px;'>"); if (!g[c]) { b.append("&nbsp;") } else { b.append(("<input id='{0}' type='checkbox' {1} />&nbsp;").format("checkboxlist_" + h + "_" + e + "_" + c, g[c]["value"] ? "checked='checked'" : "")); b.append(("<label for='{0}' style='cursor:pointer;'>{1}</label>").format("checkboxlist_" + h + "_" + e + "_" + c, g[c]["text"])) } b.append("</td>"); if ((c % a) == (a - 1)) { b.append("</tr>") } } b.append("</table>") } return b.toString() } return "" }, __clickHeader: function (d, b) { var a = "ascending"; if (d.length > 0) { for (var c = 0; c < d.length; c++) { if (c != b) { d[c].className = d[c].className.replace("grid3_hd_over", "").replace("sort_asc", "").replace("sort_desc", "") } else { if (d[c].className.indexOf("sort_asc") < 0) { d[c].className += "sort_asc"; d[c].className = d[c].className.replace("grid3_hd_over", "").replace("sort_desc", ""); a = "ascending" } else { d[c].className += "sort_desc"; d[c].className = d[c].className.replace("grid3_hd_over", "").replace("sort_asc", ""); a = "descending" } } } } return a }, __sort: function (b, a) { if (a == "ascending") { this.dataSource.sort(this.__ascsortFun(b)) } else { this.dataSource.sort(this.__descsortFun(b)) } this.DataBind(this.dataSource, this.paging) }, __ascsortFun: function (a) { return function (e, d) { if (e[a] != undefined && d[a] != undefined) { var c = e[a].toString(); var b = d[a].toString(); if (!isNaN(c) && !isNaN(b)) { return parseFloat(c) - parseFloat(b) } else { return c.localeCompare(b) } } return 0 } }, __descsortFun: function (a) { return function (e, d) { if (e[a] != undefined && d[a] != undefined) { var c = e[a].toString(); var b = d[a].toString(); if (!isNaN(c) && !isNaN(b)) { return parseFloat(b) - parseFloat(c) } else { return b.localeCompare(c) } } return 0 } }, __renderPageBox: function (a) { this.pageSetting.renderto = this.renderTo + "_Foot"; if (!this.pageBox) { this.pageBox = new Wind.UI.PageBox(this.pageSetting) } this.pageBox.DataBind(a) }, __formatWHCssText: function (a) { if (typeof a == "number") { return a + "px" } else { if (a == undefined) { return "100%" } else { return a } } }, __formatDataSource: function () { if (this.dataSource && this.dataSource.length > 0) { for (var i = 0; i < this.dataSource.length; i++) { for (var j = 0; j < this.columnCount; j++) { if (this.header[j]["type"] == "calendar") { if (this.dataSource[i][this.header[j]["dataIndex"]].toString().indexOf("Date") >= 0) { var value = this.dataSource[i][this.header[j]["dataIndex"]]; this.dataSource[i][this.header[j]["dataIndex"]] = eval("new " + value.substr(1, value.length - 2)).format(this.header[j]["exp"].replace("mm", "MM")) } } } } } } };
